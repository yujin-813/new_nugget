<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Data</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #333333;
            --text-muted: #666666;
            --border-color: #e0e0e0;
            --sidebar-width: 20%;
            --chat-width: 45%;
            --report-width: 35%;
            --navbar-height: 60px;
        }

        /* ... (skip unchanged styles) ... */

        .analysis-card .viz-btn {
            background: #4cd964;
        }

        .analysis-card .viz-btn:hover {
            background: #3cb54a;
        }

        /* [FIX] Report Chart Responsive */
        .report-card .apexcharts-canvas {
            width: 100% !important;
            max-width: 100%;
        }

        /* [FIX] Ensure chart container fits card */
        .report-card>div[id^="report-chart-"] {
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 14px;
            margin: 0;
            padding: 0;
            height: 100vh;
            background-color: var(--bg-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Navbar */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #1a1a1a;
            color: white;
            padding: 0 20px;
            height: var(--navbar-height);
            z-index: 1002;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-badge {
            font-size: 0.85em;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ccc;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-badge.active {
            color: #4cd964;
            border-color: #4cd964;
        }

        .status-badge.active::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #4cd964;
            border-radius: 50%;
        }

        .navbar-right {
            display: flex;
            gap: 10px;
        }

        .primary-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .primary-btn:hover {
            background-color: var(--primary-hover);
        }

        .outline-btn {
            background: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        .outline-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Workspace Layout */
        .workspace {
            display: flex;
            flex: 1;
            overflow: hidden;
            width: 100%;
        }

        /* Left Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            min-width: 250px;
            background: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .sidebar.collapsed {
            width: 0;
            min-width: 0;
            overflow: hidden;
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-menu {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 8px;
            color: var(--text-main);
            text-decoration: none;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 5px;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }

        .menu-item:hover {
            background-color: #f0f0f0;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
            color: var(--text-muted);
        }

        /* Main Chat Area */
        .chat-main {
            width: var(--chat-width);
            flex: 1;
            /* Fallback */
            display: flex;
            flex-direction: column;
            background-color: white;
            position: relative;
            border-right: 1px solid var(--border-color);
            transition: width 0.3s ease;
        }

        .chat-header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            margin: 0;
            font-size: 1.1em;
            font-weight: 700;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Message Styles */
        .message {
            max-width: 80%;
            padding: 15px;
            border-radius: 12px;
            line-height: 1.5;
            position: relative;
        }

        .user-message {
            align-self: flex-end;
            background-color: #e3f2fd;
            color: #0d47a1;
            border-bottom-right-radius: 2px;
        }

        .bot-message {
            align-self: flex-start;
            background-color: #f5f5f5;
            color: var(--text-main);
            border-bottom-left-radius: 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Clarify Chips */
        .clarify-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .clarify-chip {
            border: 1px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            padding: 6px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
        }

        .clarify-chip:hover {
            background: var(--primary-color);
            color: white;
        }

        /* Add to Report Button */
        .add-to-report {
            display: inline-block;
            margin-top: 12px;
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.85em;
            border: none;
        }

        .add-to-report:hover {
            background-color: var(--primary-hover);
        }

        /* Input Area */
        .input-area {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background: white;
        }

        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
            background: #f9f9f9;
            padding: 8px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: border-color 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: var(--primary-color);
            background: white;
        }

        .input-wrapper input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px;
            font-size: 15px;
            outline: none;
        }

        .send-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Right Report Panel (SaaS Style) */
        .report-panel {
            width: var(--report-width);
            min-width: 350px;
            background: #f0f2f5;
            /* Light Gray Background for distinct 'workspace' feel */
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease, transform 0.3s ease;
            position: relative;
            z-index: 1001;
            /* Above minimal layout */
        }

        .report-panel.collapsed {
            width: 0;
            min-width: 0;
            overflow: hidden;
            /* transform: translateX(100%); Removed transform to keep flow */
        }

        .report-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* A4 Paper Style Container */
        .report-container {
            width: 90%;
            max-width: 210mm;
            /* A4 Width */
            margin: 20px auto;
            background: white;
            min-height: 297mm;
            /* A4 Height */
            padding: 25mm;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            /* Minimal shadow */
            border: 1px solid #e0e0e0;
            border-radius: 2px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .report-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            /* Removing padding to let container handle margins */
            background: #f0f2f5;
        }

        /* Report Card inside Document */
        .report-card {
            background: white;
            border: 1px solid transparent;
            /* Cleaner look */
            border-bottom: 1px solid #eee;
            /* Separator like */
            border-radius: 4px;
            /* Minimal radius */
            padding: 15px 0;
            /* Vertical spacing */
            margin-bottom: 10px;
            box-shadow: none;
            /* Flat look for document */
            position: relative;
        }

        .report-card:hover {
            border-color: #eee;
            background: #fafafa;
        }

        /* Onboarding */
        .onboarding {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .onboarding h1 {
            color: var(--text-main);
            margin-bottom: 10px;
        }

        .onboarding-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
            max-width: 600px;
        }

        .onboarding-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .onboarding-card:hover {
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            font-size: 0.9em;
        }

        .form-control {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            outline: none;
        }

        .form-control:focus {
            border-color: var(--primary-color);
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        /* Existing component overrides */
        #report-container {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0;
            border: none;
            background: transparent;
            margin-top: 0;
        }

        .report-columns {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .report-column {
            min-height: auto;
            border: none;
            padding: 0;
        }

        /* [PHASE 1] Analysis Card Styles */
        .analysis-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin: 16px 0;
            border-left: 4px solid var(--primary-color);
        }

        .analysis-card h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .analysis-card .main-metric {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
            margin: 12px 0;
            line-height: 1.2;
        }

        .analysis-card .delta {
            font-size: 18px;
            font-weight: 600;
            margin: 8px 0;
        }

        .analysis-card .delta.positive {
            color: #4cd964;
        }

        .analysis-card .delta.negative {
            color: #ff3b30;
        }

        .analysis-card .comparison {
            display: flex;
            gap: 20px;
            margin: 16px 0;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            font-size: 14px;
        }

        .analysis-card .comparison span {
            color: var(--text-muted);
        }

        .analysis-card .insight {
            color: var(--text-muted);
            line-height: 1.6;
            margin: 16px 0;
        }

        .analysis-card .insight p {
            margin: 8px 0;
        }

        .analysis-card .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .analysis-card .add-to-report {
            flex: 1;
            padding: 10px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .analysis-card .add-to-report:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .analysis-card .viz-btn {
            background: #4cd964;
        }

        .analysis-card .viz-btn:hover {
            background: #3cb54a;
        }

        /* [PHASE 4] Sortable Ghost Style */
        .sortable-ghost {
            opacity: 0.4;
            background: #f0f0f0;
            border: 2px dashed #ccc;
        }

        /* [PHASE 7] View Mode & A4 Layout */
        .view-mode .report-column {
            border: none !important;
            background: white !important;
            box-shadow: none !important;
            width: 210mm;
            /* A4 width */
            margin: 0 auto;
            min-height: 297mm;
            /* A4 height */
            padding: 20mm;
            box-sizing: border-box;
        }

        .view-mode .report-card {
            border: none;
            box-shadow: none;
            padding: 10px 0;
        }

        /* Hide edit tools in view mode */
        .view-mode .card-actions,
        .view-mode .delete-btn,
        .view-mode .edit-btn,
        .view-mode .outline-btn {
            /* Hide toggle buttons in charts if needed, or keep them? User asked for view mode layout. Let's hide controls. */
            display: none !important;
        }

        /* contentEditable disabled visual */
        .view-mode .report-content[contenteditable] {
            outline: none;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            #report-container,
            #report-container * {
                visibility: visible;
            }

            #report-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }



            .report-column {
                width: 100% !important;
                box-shadow: none !important;
                border: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="navbar-left">
            <h2 style="margin:0; font-weight:900; letter-spacing:-1px;">NUGGET</h2>
            <div class="status-badge" id="ga4-status-badge">GA4: None</div>
            <div class="status-badge" id="file-status-badge">File: None</div>
            <div class="status-badge active" id="mode-status-badge">Mode: Auto</div>
            <span id="account-name" style="display:none;"></span>
        </div>
        <div class="navbar-center">
            <button id="connect-data-btn" class="primary-btn" onclick="openConnectModal()">Connect Data</button>
        </div>
        <div class="navbar-right">
            <button id="report-toggle-btn" class="outline-btn" onclick="toggleReportPanel()">Show Report</button>
            <button id="logout-button" class="outline-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="workspace">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="primary-btn" style="width:100%" onclick="createNewReport()">
                    <i class="fas fa-plus"></i> ÏÉà Î¶¨Ìè¨Ìä∏ ÏûëÏÑ±
                </button>
            </div>
            <div class="sidebar-menu">
                <button class="menu-item" onclick="showDataManagement()">
                    <i class="fas fa-database"></i> Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨
                </button>
                <div class="search-container" style="padding: 10px 0;">
                    <input type="text" id="search-reports" placeholder="Î¶¨Ìè¨Ìä∏ Í≤ÄÏÉâ" oninput="filterReports()"
                        style="width:100%; padding:8px; border-radius:6px; border:1px solid var(--border-color);">
                </div>
                <ul id="reports-list" style="list-style:none; padding:0; margin:0;">
                    <li style="padding:10px; color:var(--text-muted); font-style:italic;">No saved reports</li>
                </ul>
            </div>
        </div>

        <div class="chat-main" id="chat-main">
            <div class="messages-container" id="chat">
                <div class="onboarding" id="onboarding-ui">
                    <div
                        style="background:#fff; padding:40px; border-radius:24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);">
                        <h1>Î∞òÍ∞ÄÏõåÏöî! Î¨¥ÏóáÏùÑ ÎèÑÏôÄÎìúÎ¶¥ÍπåÏöî?</h1>
                        <p>NUGGETÏùÄ GA4ÏôÄ ÌååÏùº Îç∞Ïù¥ÌÑ∞Î•º Î∂ÑÏÑùÌïòÏó¨ Ïù∏ÏÇ¨Ïù¥Ìä∏Î•º Ï†úÍ≥µÌï©ÎãàÎã§.</p>

                        <div class="onboarding-grid">
                            <div class="onboarding-card" onclick="openConnectModal()">
                                <h3>üîå 1. Îç∞Ïù¥ÌÑ∞ Ïó∞Í≤∞ÌïòÍ∏∞</h3>
                                <p>GA4 ÎòêÎäî CSV ÌååÏùºÏùÑ Ïó∞Í≤∞Ìï¥ Î∂ÑÏÑùÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî.</p>
                            </div>
                            <div class="onboarding-card" onclick="setInputAndAsk('ÏßÄÎÇúÏ£º ÌôúÏÑ± ÏÇ¨Ïö©Ïûê ÏàòÎ•º ÏïåÎ†§Ï§ò')">
                                <h3>üìä 2. ÏÉòÌîå ÏßàÎ¨∏ Ìï¥Î≥¥Í∏∞</h3>
                                <p>"ÏßÄÎÇúÏ£º ÌôúÏÑ± ÏÇ¨Ïö©Ïûê ÏàòÎäî?" Ï≤òÎüº ÏßàÎ¨∏Ìï¥ Î≥¥ÏÑ∏Ïöî.</p>
                            </div>
                            <div class="onboarding-card" onclick="createNewReport()">
                                <h3>üìù 3. Î¶¨Ìè¨Ìä∏ ÎßåÎì§Í∏∞</h3>
                                <p>Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Î¶¨Ìè¨Ìä∏Ïóê Ï∂îÍ∞ÄÌïòÍ≥† Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.</p>
                            </div>
                            <div class="onboarding-card" onclick="showDataManagement()">
                                <h3>üìÇ 4. Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</h3>
                                <p>ÌååÏùº ÏóÖÎ°úÎìú Î∞è Ï†ÑÏ≤òÎ¶¨ Îç∞Ïù¥ÌÑ∞Î•º Í¥ÄÎ¶¨Ìï©ÎãàÎã§.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div style="padding:0 16px 8px; display:flex; align-items:center;">
                    <input type="checkbox" id="auto-add-to-report" style="margin-right:6px; cursor:pointer;">
                    <label for="auto-add-to-report" style="font-size:12px; color:#666; cursor:pointer;">ÏûêÎèôÏúºÎ°ú Î¶¨Ìè¨Ìä∏Ïóê Ï∂îÍ∞Ä
                        (Auto-add to Report)</label>
                </div>
                <div class="input-wrapper">
                    <input type="text" id="question-input" placeholder="Îç∞Ïù¥ÌÑ∞Ïóê ÎåÄÌï¥ ÏßàÎ¨∏Ìï¥ Î≥¥ÏÑ∏Ïöî (Ïòà: ÏßÄÎÇúÎã¨ ÏÑ±Í≥º ÏöîÏïΩÌï¥Ï§ò)">
                    <button id="ask-button" class="send-btn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="report-panel" id="report-panel">
            <!-- Collapsed by default removed? No, user wants 3-col. Should be open by default. -->
            <div class="report-header">
                <h3 style="margin:0; font-size:16px;">üìÑ Report Document</h3>
                <div style="display:flex; gap:10px;">
                    <button class="outline-btn" style="color:#333; border-color:#ddd;" onclick="saveReport()">
                        <i class="fas fa-save"></i> Ï†ÄÏû•
                    </button>
                    <button onclick="toggleReportPanel()"
                        style="background:none; border:none; cursor:pointer; font-size:1.2em; color:#666;">&times;</button>
                </div>
            </div>
            <div class="report-scroll">
                <div id="report-container" class="report-container">
                    <!-- Title Area -->
                    <div style="margin-bottom:20px; border-bottom:2px solid #333; padding-bottom:10px;">
                        <input type="text" id="report-title" placeholder="Î¶¨Ìè¨Ìä∏ Ï†úÎ™© ÏûÖÎ†•"
                            style="width:100%; border:none; font-size:24px; font-weight:bold; outline:none; background:transparent;"
                            value="Î¨¥Ï†ú Î¶¨Ìè¨Ìä∏">
                        <div style="color:#666; font-size:12px; margin-top:5px;">2026-02-12</div>
                    </div>

                    <!-- [PHASE 7] View Mode Toggle -->
                    <div style="display:flex; align-items:center; gap:6px; margin-right:8px;">
                        <label class="switch" style="position:relative; display:inline-block; width:34px; height:20px;">
                            <input type="checkbox" id="view-mode-toggle" onchange="toggleViewMode(this)">
                            <span class="slider round"
                                style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:34px;"></span>
                            <style>
                                .slider:before {
                                    position: absolute;
                                    content: "";
                                    height: 14px;
                                    width: 14px;
                                    left: 3px;
                                    bottom: 3px;
                                    background-color: white;
                                    transition: .4s;
                                    border-radius: 50%;
                                }

                                input:checked+.slider {
                                    background-color: var(--primary-color);
                                }

                                input:checked+.slider:before {
                                    transform: translateX(14px);
                                }
                            </style>
                        </label>
                        <span style="font-size:12px; color:#666;">Î≥¥Í∏∞ Î™®Îìú</span>
                    </div>

                    <button class="primary-btn" onclick="saveReport()">Ï†ÄÏû•</button>
                    <button class="outline-btn" style="color:var(--text-main); border-color:var(--text-muted);"
                        onclick="downloadReportAsImage()">Îã§Ïö¥Î°úÎìú</button>


                    <!-- [PHASE 3] Report Agent Input -->
                    <div
                        style="margin-bottom:15px; padding:12px; background:#f9f9f9; border-radius:8px; border:1px solid #eee;">
                        <div style="font-weight:600; font-size:12px; color:#666; margin-bottom:8px;">ü§ñ Report Agent
                            (Beta)</div>
                        <div style="display:flex; gap:8px;">
                            <input type="text" id="report-agent-input" placeholder="Î¶¨Ìè¨Ìä∏ Ï†ÑÏ≤¥Î•º ÏàòÏ†ï/ÏöîÏïΩÌï¥Ï§ò (Ïòà: Îçî Í∞ÑÍ≤∞ÌïòÍ≤å Îã§Îì¨Ïñ¥Ï§ò)"
                                style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:13px;">
                            <button class="primary-btn" onclick="runReportAgent()"
                                style="font-size:13px; padding:8px 12px; height:auto; min-width:60px;">Ïã§Ìñâ</button>
                        </div>
                    </div>

                    <div id="report" class="report-columns">
                        <div class="report-column" data-column="1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Connect Modal -->
    <div class="modal-overlay" id="connect-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0">Data Connection</h3>
                <button onclick="closeConnectModal()"
                    style="background:none; border:none; cursor:pointer; font-size:1.2em;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>GA4 Account</label>
                    <select id="account-select" class="form-control">
                        <option value="">Select Account</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>GA4 Property</label>
                    <select id="property-select" class="form-control" onchange="setProperty()">
                        <option value="">Select Property</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Preprocessed Data (CSV)</label>
                    <div id="data-select-container">
                        <div id="data-select-display" class="form-control" style="cursor:pointer;">Select Preprocessed
                            Data</div>
                        <div id="data-select-options" class="dropdown-content"
                            style="position:static; border:1px solid var(--border-color); border-top:none; max-height:150px; overflow-y:auto; display:none;">
                            <!-- Options will be populated dynamically -->
                        </div>
                    </div>
                </div>
                <div style="margin-top:10px;">
                    <button class="primary-btn" style="width:100%" onclick="selectDataset(); closeConnectModal();">Apply
                        Connection</button>
                </div>
            </div>
        </div>
    </div>

    <div id="data-management-container" class="modal-overlay"
        style="display:none; align-items:flex-start; padding-top:50px;">
        <div class="modal-content" style="max-width:90%; width:1000px; height:80vh; overflow-y:auto;">
            <div class="modal-header">
                <h3 style="margin:0">Data Management</h3>
                <button onclick="closeDataManagement()"
                    style="background:none; border:none; cursor:pointer; font-size:1.2em;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="upload-section"
                    style="background:#f9f9f9; padding:20px; border-radius:12px; border:1px dashed #ccc; text-align:center;">
                    <p>Ï§ÄÎπÑ Ï§ëÏù∏ Í∏∞Îä•ÏûÖÎãàÎã§.</p>
                </div>
            </div>
        </div>
    </div>


    <script>
        let isFetching = false;
        let savedReports = [];

        /* =========================
           1. Í∏∞Î≥∏ Ï¥àÍ∏∞Ìôî Î∞è UI Ï†úÏñ¥
        ========================= */
        document.addEventListener("DOMContentLoaded", () => {
            initChat();
            fetchAccounts();
            loadPreprocessedDataOptions();
            loadReportsList();

            const panel = document.getElementById('report-panel');
            panel.classList.add('collapsed');

            const btn = document.getElementById("report-toggle-btn");
            if (btn) btn.innerText = "Show Report";

            // Îç∞Ïù¥ÌÑ∞ Ïó∞Îèô Í¥ÄÎ†® ÎìúÎ°≠Îã§Ïö¥ Ïù¥Î≤§Ìä∏
            const dataSelectContainer = document.getElementById('data-select-container');
            if (dataSelectContainer) {
                dataSelectContainer.addEventListener('click', function (e) {
                    const opt = document.getElementById('data-select-options');
                    opt.style.display = opt.style.display === 'block' ? 'none' : 'block';
                    e.stopPropagation();
                });
            }
            document.addEventListener('click', () => {
                const opt = document.getElementById('data-select-options');
                if (opt) opt.style.display = 'none';
            });
        });




        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        function toggleReportPanel() {
            const panel = document.getElementById('report-panel');
            panel.classList.toggle('collapsed');

            const btn = document.getElementById("report-toggle-btn");
            if (btn) {
                btn.innerText = panel.classList.contains("collapsed") ? "Show Report" : "Hide Report";
            }
        }


        function openConnectModal() {
            document.getElementById('connect-modal').classList.add('active');
        }

        function closeConnectModal() {
            document.getElementById('connect-modal').classList.remove('active');
        }

        function showDataManagement() {
            const container = document.getElementById('data-management-container');
            if (container) container.classList.add('active');
        }

        function closeDataManagement() {
            const container = document.getElementById('data-management-container');
            if (container) container.classList.remove('active');
        }

        function setInputAndAsk(text) {
            const input = document.getElementById('question-input');
            input.value = text;
            fetchTrafficData();
        }

        /* =========================
           2. ÏßàÎ¨∏ Ï≤òÎ¶¨ (ÏïàÏ†ï Î≤ÑÏ†Ñ)
        ========================= */
        function initChat() {
            const input = document.getElementById('question-input');
            const btn = document.getElementById('ask-button');
            if (!input || !btn) return;
            input.addEventListener('input', () => { btn.disabled = input.value.trim().length === 0; });
            btn.addEventListener('click', fetchTrafficData);
            input.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !btn.disabled) fetchTrafficData(); });
        }

        async function fetchTrafficData() {
            if (isFetching) return;

            const input = document.getElementById('question-input');
            const question = input.value.trim();
            if (!question) return;

            const onboarding = document.getElementById('onboarding-ui');
            if (onboarding) onboarding.classList.add('hidden');

            appendMessage('user', question);
            input.value = '';
            isFetching = true;
            document.getElementById('ask-button').disabled = true;

            try {
                const res = await fetch('/ask_question', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question })
                });

                const data = await res.json();
                const response = data.response || {};

                if (response.status === 'clarify') {
                    handleClarifyResponse(response, question);

                } else if (response.blocks && Array.isArray(response.blocks)) {
                    renderMultiScopeBlocks(response);

                } else {
                    const plotData = response.plot_data || null;
                    const structuredInsight = response.structured_insight || null;
                    appendMessage('bot', response.message || "ÏùëÎãµÏù¥ ÏóÜÏäµÎãàÎã§.", plotData, structuredInsight);
                }

                if (data.route) {
                    const badge = document.getElementById('mode-status-badge');
                    badge.innerText = `Mode: ${String(data.route).toUpperCase()}`;
                    badge.classList.add('active');
                }

            } catch (err) {
                appendMessage('bot', "Ïò§Î•ò Î∞úÏÉù: " + err.message);
            } finally {
                isFetching = false;
                document.getElementById('ask-button').disabled = false;
            }
        }

        function renderMultiScopeBlocks(response) {
            const chat = document.getElementById('chat');

            response.blocks.forEach(block => {
                const card = document.createElement('div');
                card.className = 'analysis-card';

                let html = `<h3>üìä ${block.title || 'Î∂ÑÏÑù Î∏îÎ°ù'}</h3>`;

                if (block.scope === "event" && block.data && typeof block.data === "object") {
                    Object.entries(block.data).forEach(([key, value]) => {
                        html += `<div class="main-metric">${key}: ${Number(value).toLocaleString()}</div>`;
                    });
                }

                if (block.scope === "item" && Array.isArray(block.data)) {
                    html += `<div class="insight">`;
                    block.data.slice(0, 20).forEach(row => {   // ÎÑàÎ¨¥ Í∏∏Ïñ¥Ïßà Ïàò ÏûàÏñ¥ÏÑú 20Í∞úÎßå
                        const values = Object.entries(row).map(([k, v]) => `${k}: ${v}`).join(" | ");
                        html += `<p>${values}</p>`;
                    });
                    html += `</div>`;
                }

                card.innerHTML = html;
                chat.appendChild(card);
            });

            chat.scrollTop = chat.scrollHeight;
        }



        function appendMessage(role, text, plotData = null, structuredInsight = null) {
            const chat = document.getElementById('chat');

            // [PHASE 1] Render analysis card if structured insight is available
            if (role === 'bot' && structuredInsight) {
                renderAnalysisCard(structuredInsight, plotData);

                // [PHASE 3] Auto-add to report if checkbox is checked
                const autoAddCheckbox = document.getElementById('auto-add-to-report');
                if (autoAddCheckbox && autoAddCheckbox.checked) {
                    // Create a temporary card to get HTML
                    const tempCard = document.createElement('div');
                    // We need to re-render to get HTML or extract content
                    // Simpler: just pass the structured insight to addToReport directly?
                    // addToReport expects HTML text.
                    // Let's modify renderAnalysisCard to return the card element or HTML, 
                    // or just use a timeout to wait for rendering? 
                    // Better: reuse the logic.
                    // Let's wait for renderAnalysisCard to finish (it appends to chat).
                    // Actually, renderAnalysisCard appends to chat. 
                    // We can just get the last child of chat or similar.
                    // Or better, let renderAnalysisCard handle auto-add if we pass a flag?
                    // No, keeping functions separate is better.

                    // Let's construct the HTML text for report.
                    // Converting structuredInsight to HTML string again is redundant.
                    // Let's grab the structured insight content.

                    // Alternative: Modify renderAnalysisCard to accept an autoAdd flag? 
                    // Or let's just trigger the "Add to Report" button click programmatically?
                    // That's a bit hacky but works.

                    setTimeout(() => {
                        const cards = document.getElementsByClassName('analysis-card');
                        if (cards.length > 0) {
                            const lastCard = cards[cards.length - 1];
                            const htmlContent = lastCard.innerHTML;
                            // Remove action buttons from the content before adding? 
                            // addToReport adds its own buttons. 
                            // We need to pass the raw HTML content (title, metrics, etc.)
                            // clone and remove actions?
                            const clone = lastCard.cloneNode(true);
                            const actions = clone.querySelector('.card-actions');
                            if (actions) actions.remove();

                            addToReport(clone.innerHTML, plotData);
                        }
                    }, 100);
                }
                return;
            }

            // Original message rendering
            const div = document.createElement('div');
            div.className = `message ${role === 'user' ? 'user-message' : 'bot-message'}`;
            div.innerHTML = `<p><strong>${role === 'user' ? 'You' : 'Bot'}:</strong> ${text}</p>`;

            if (role === 'bot') {
                const btnGroup = document.createElement('div');
                btnGroup.className = 'btn-group';
                btnGroup.style.display = 'flex';
                btnGroup.style.gap = '8px';
                btnGroup.style.marginTop = '12px';

                // [v9.2] Visualize Button
                if (plotData && plotData.labels && plotData.labels.length > 0 && plotData.series && plotData.series.length > 0) {
                    const vizBtn = document.createElement('button');
                    vizBtn.className = 'add-to-report';
                    vizBtn.style.backgroundColor = '#4cd964'; // Green for Viz
                    vizBtn.innerHTML = '<i class="fas fa-chart-bar"></i> ÏãúÍ∞ÅÌôîÌïòÍ∏∞';
                    vizBtn.onclick = () => {
                        const chartId = 'chart-' + generateUniqueId();
                        const chartCont = document.createElement('div');
                        chartCont.id = chartId;
                        chartCont.style.marginTop = '15px';
                        chartCont.style.backgroundColor = '#fff';
                        chartCont.style.padding = '10px';
                        chartCont.style.borderRadius = '8px';
                        chartCont.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';
                        div.appendChild(chartCont);
                        renderApexChart(chartId, plotData);
                        vizBtn.disabled = true;
                        vizBtn.style.opacity = '0.5';
                    };
                    btnGroup.appendChild(vizBtn);
                }

                const reportBtn = document.createElement('button');
                reportBtn.className = 'add-to-report';
                reportBtn.innerHTML = '<i class="fas fa-file-alt"></i> Î¶¨Ìè¨Ìä∏Ïóê Ï∂îÍ∞Ä';
                reportBtn.onclick = () => { addToReport(text, plotData); openReportPanel(); };
                btnGroup.appendChild(reportBtn);

                div.appendChild(btnGroup);
            }
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        // [PHASE 1] Render Analysis Card
        function renderAnalysisCard(data, plotData = null) {
            const chat = document.getElementById('chat');
            const card = document.createElement('div');
            card.className = 'analysis-card';

            let html = `<h3>üìä ${data.title || 'Î∂ÑÏÑù Í≤∞Í≥º'}</h3>`;

            if (data.main_metric) {
                html += `<div class="main-metric">${data.main_metric}</div>`;
            }

            if (data.delta) {
                const deltaClass = data.delta.includes('+') ? 'positive' : (data.delta.includes('-') ? 'negative' : '');
                html += `<div class="delta ${deltaClass}">${data.delta}</div>`;
            }

            if (data.comparison && data.comparison.previous && data.comparison.current) {
                html += `
                    <div class="comparison">
                        <span>Ïù¥Ï†Ñ: ${data.comparison.previous}</span>
                        <span>ÌòÑÏû¨: ${data.comparison.current}</span>
                    </div>
                `;
            }

            if (data.insight_narrative) {
                html += `<div class="insight"><p>${data.insight_narrative.replace(/\n/g, "<br>")}</p></div>`;
            }

            card.innerHTML = html;

            // Add action buttons
            const actions = document.createElement('div');
            actions.className = 'card-actions';

            if (plotData && plotData.labels && plotData.labels.length > 0) {
                const vizBtn = document.createElement('button');
                vizBtn.className = 'add-to-report viz-btn';
                vizBtn.innerHTML = '<i class="fas fa-chart-bar"></i> ÏãúÍ∞ÅÌôîÌïòÍ∏∞';
                vizBtn.onclick = () => {
                    const chartId = 'chart-' + generateUniqueId();
                    const chartCont = document.createElement('div');
                    chartCont.id = chartId;
                    chartCont.style.marginTop = '15px';
                    chartCont.style.backgroundColor = '#fff';
                    chartCont.style.padding = '10px';
                    chartCont.style.borderRadius = '8px';
                    chartCont.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';
                    card.appendChild(chartCont);
                    renderApexChart(chartId, plotData);
                    vizBtn.disabled = true;
                    vizBtn.style.opacity = '0.5';
                };
                actions.appendChild(vizBtn);
            }

            const reportBtn = document.createElement('button');
            reportBtn.className = 'add-to-report';
            reportBtn.innerHTML = '<i class="fas fa-file-alt"></i> Î¶¨Ìè¨Ìä∏Ïóê Ï∂îÍ∞Ä';
            reportBtn.onclick = () => {
                addToReport(card.innerHTML, plotData);
                openReportPanel();
            };
            actions.appendChild(reportBtn);

            card.appendChild(actions);
            chat.appendChild(card);
            chat.scrollTop = chat.scrollHeight;
        }

        // ApexCharts Rendering [FIXED]
        function renderApexChart(elementId, plotData) {
            if (typeof ApexCharts === 'undefined') {
                console.error("ApexCharts not loaded");
                return;
            }
            if (!plotData || !plotData.labels || !plotData.series) return;

            // [FIX] Check for datetime labels
            let isDatetime = false;
            // Check if first label looks like a date (YYYY-MM-DD)
            if (plotData.labels.length > 0) {
                const firstLabel = String(plotData.labels[0]);
                if (firstLabel.match(/^\d{4}-\d{2}-\d{2}/)) {
                    isDatetime = true;
                }
            }

            const options = {
                series: plotData.series,
                chart: {
                    type: plotData.type || 'bar',
                    height: plotData.height || 350,
                    width: '100%', // [FIX] Force width to 100%
                    fontFamily: 'Noto Sans KR, sans-serif',
                    toolbar: { show: false },
                    zoom: { enabled: false }
                },
                plotOptions: {
                    bar: { borderRadius: 4, horizontal: false }
                },
                dataLabels: { enabled: false },
                stroke: { curve: 'smooth', width: 2 },
                xaxis: {
                    categories: plotData.labels,
                    type: isDatetime ? 'datetime' : 'category', // [FIX] Use datetime type if detected
                    labels: {
                        style: { fontSize: '12px' },
                        datetimeFormatter: {
                            year: 'yyyy',
                            month: 'MMM \'yy',
                            day: 'dd MMM',
                            hour: 'HH:mm'
                        }
                    },
                    tooltip: { enabled: false }
                },
                yaxis: {
                    labels: {
                        formatter: function (val) {
                            // Format large numbers
                            if (val >= 1000000) return (val / 1000000).toFixed(1) + 'M';
                            if (val >= 1000) return (val / 1000).toFixed(1) + 'K';
                            return val.toLocaleString();
                        }
                    }
                },
                fill: { opacity: 1 },
                tooltip: {
                    x: {
                        format: isDatetime ? 'dd MMM yyyy' : undefined
                    }
                },
                colors: ['#007bff', '#4cd964', '#ff3b30', '#ffc107', '#6f42c1'] // [v9.2] Varied colors
            };

            const chart = new ApexCharts(document.getElementById(elementId), options);
            chart.render();
        }

        function handleClarifyResponse(data, originalQuestion) {
            const chat = document.getElementById('chat');
            const botDiv = document.createElement('div');
            botDiv.className = 'message bot-message';
            botDiv.innerHTML = `<p><strong>Bot:</strong> ${data.message}</p>`;
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'clarify-container';
            data.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.innerText = opt;
                btn.className = 'clarify-chip';
                btn.onclick = () => { setInputAndAsk(`${originalQuestion} ${opt} Í∏∞Ï§ÄÏúºÎ°ú`); };
                optionsDiv.appendChild(btn);
            });
            botDiv.appendChild(optionsDiv);
            chat.appendChild(botDiv);
            chat.scrollTop = chat.scrollHeight;
        }
        /* =========================
           3. GA4 & Îç∞Ïù¥ÌÑ∞ Ïó∞Îèô
        ========================= */
        async function fetchAccounts() {
            try {
                const res = await fetch("/list_all");
                const accounts = await res.json();
                const select = document.getElementById("account-select");
                select.innerHTML = '<option value="">Select Account</option>';
                accounts.forEach(acc => {
                    const option = document.createElement("option");
                    option.value = acc.id;
                    option.textContent = acc.name;
                    select.appendChild(option);
                });
            } catch (err) { console.error(err); }
        }

        document.getElementById("account-select")?.addEventListener("change", async (e) => {
            const accountId = e.target.value;
            if (!accountId) return;
            const res = await fetch(`/list_properties?accountId=${accountId}`);
            const data = await res.json();

            console.log("properties response:", data);

            const propSelect = document.getElementById("property-select");
            propSelect.innerHTML = '<option value="">Select Property</option>';

            // üî• ÏùëÎãµ Íµ¨Ï°∞Í∞Ä Î∞∞Ïó¥Ïù∏ Í≤ΩÏö∞Ïóê ÎßûÏ∂∞ ÏàòÏ†ï
            data.forEach(prop => {
                const option = document.createElement("option");
                option.value = prop.id;
                option.textContent = prop.name; // prop.displayNameÏù¥ ÏïÑÎãàÎùº prop.name ÏÇ¨Ïö©
                propSelect.appendChild(option);
            });
        });

        async function setProperty() {
            const select = document.getElementById("property-select");
            const propertyId = select.value;
            const propertyName = select.options[select.selectedIndex].text;

            if (!propertyId) return;

            const res = await fetch('/set_property', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    property_id: propertyId,
                    property_name: propertyName
                })
            });

            const data = await res.json();
            console.log("set_property response:", data);

            if (res.ok) {
                document.getElementById("ga4-status-badge").innerText = `GA4: ${propertyName}`;
                document.getElementById("ga4-status-badge").classList.add("active");
                closeConnectModal();
            }
        }

        function loadPreprocessedDataOptions() {
            fetch('/list_preprocessed_data').then(res => res.json()).then(files => {
                const optDiv = document.getElementById('data-select-options');
                if (!optDiv) return;
                optDiv.innerHTML = '';
                files.forEach(file => {
                    const div = document.createElement('div');
                    div.innerHTML = `<input type="checkbox" value="${file}"> ${file}`;
                    div.onclick = (e) => { e.stopPropagation(); };
                    div.querySelector('input').onchange = () => selectDataset();
                    optDiv.appendChild(div);
                });
            });
        }

        async function selectDataset() {
            const selected = Array.from(document.querySelectorAll('#data-select-options input:checked')).map(cb => cb.value);
            const badge = document.getElementById('file-status-badge');
            if (selected.length > 0) {
                badge.innerText = `File: ${selected[0]}`;
                badge.classList.add('active');

                // üî• ÏÑúÎ≤Ñ ÏÑ∏ÏÖòÏóê ÏÑ†ÌÉùÎêú dataset Í≤ΩÎ°ú Ï†ÄÏû•
                await fetch(`/get_preprocessed_data?dataset_name=${encodeURIComponent(selected[0])}`);
            } else {
                badge.innerText = 'File: None';
                badge.classList.remove('active');
            }
        }

        /* =========================
           4. Í∏∞ÌÉÄ Ïú†Ìã∏Î¶¨Ìã∞
        ========================= */
        // [PHASE 2] Enhanced addToReport with contenteditable and action buttons
        function addToReport(text, plotData = null) {
            const column = document.querySelector('.report-column');
            if (!column) return;

            const div = document.createElement('div');
            div.className = 'report-card';
            div.style.position = 'relative';

            // üî• plotData Ï†ÄÏû• (Ï∞®Ìä∏ Î≥µÏõêÏö©)
            if (plotData) {
                div.dataset.plot = JSON.stringify(plotData);
            }


            // [PHASE 2] Contenteditable text content
            const contentDiv = document.createElement('div');
            contentDiv.className = 'report-content';
            contentDiv.contentEditable = 'true';
            contentDiv.innerHTML = text;
            contentDiv.style.outline = 'none';
            div.appendChild(contentDiv);

            // [PHASE 2] Action buttons
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'card-actions';
            actionsDiv.style.display = 'flex';
            actionsDiv.style.gap = '8px';
            actionsDiv.style.marginTop = '12px';
            actionsDiv.style.opacity = '0'; // Hide by default
            actionsDiv.style.transition = 'opacity 0.2s';

            // Show actions on hover
            div.onmouseenter = () => actionsDiv.style.opacity = '1';
            div.onmouseleave = () => actionsDiv.style.opacity = '0';

            // AI Edit button
            const aiBtn = document.createElement('button');
            aiBtn.className = 'edit-btn';
            aiBtn.innerHTML = 'ü§ñ AI Ìé∏Ïßë';
            aiBtn.style.padding = '4px 8px';
            aiBtn.style.fontSize = '12px';
            aiBtn.style.cursor = 'pointer';
            aiBtn.style.border = '1px solid #ddd';
            aiBtn.style.borderRadius = '4px';
            aiBtn.style.background = 'white';
            aiBtn.onclick = () => showEditOptions(contentDiv);
            actionsDiv.appendChild(aiBtn);

            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = 'üóëÔ∏è ÏÇ≠Ï†ú';
            deleteBtn.style.padding = '4px 8px';
            deleteBtn.style.fontSize = '12px';
            deleteBtn.style.cursor = 'pointer';
            deleteBtn.style.border = '1px solid #ddd';
            deleteBtn.style.borderRadius = '4px';
            deleteBtn.style.background = 'white';
            deleteBtn.onclick = () => div.remove();
            actionsDiv.appendChild(deleteBtn);

            div.appendChild(actionsDiv);

            // [v9.4] Chart Content in Report with Toggle
            if (plotData && plotData.labels && plotData.labels.length > 0) {
                const chartWrapper = document.createElement('div');
                chartWrapper.style.marginTop = '10px';

                // Toggle Button
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'outline-btn';
                toggleBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Ï∞®Ìä∏ Ïà®Í∏∞Í∏∞';
                toggleBtn.style.fontSize = '12px';
                toggleBtn.style.padding = '4px 8px';
                toggleBtn.style.marginBottom = '8px';

                const chartId = 'report-chart-' + generateUniqueId();
                div.dataset.chartId = chartId;

                const chartCont = document.createElement('div');
                chartCont.id = chartId;
                chartCont.style.minHeight = '200px';
                chartCont.style.transition = 'all 0.3s ease';

                toggleBtn.onclick = () => {
                    if (chartCont.style.display === 'none') {
                        chartCont.style.display = 'block';
                        toggleBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Ï∞®Ìä∏ Ïà®Í∏∞Í∏∞';
                    } else {
                        chartCont.style.display = 'none';
                        toggleBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Ï∞®Ìä∏ Î≥¥Í∏∞';
                    }
                };

                chartWrapper.appendChild(toggleBtn);
                chartWrapper.appendChild(chartCont);
                div.appendChild(chartWrapper);

                // Use a smaller height for report charts
                setTimeout(() => {
                    renderApexChart(chartId, {
                        ...plotData,
                        height: 250 // Override default height for report
                    });
                }, 100);
            }

            column.appendChild(div);
            // Scroll to bottom
            column.scrollTop = column.scrollHeight;
        }

        // [PHASE 3 & 6] Run Report Agent with Safety Check
        async function runReportAgent() {
            const input = document.getElementById('report-agent-input');
            const instruction = input.value.trim();
            if (!instruction) {
                alert('ÏöîÏ≤≠ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            const column = document.querySelector('.report-column');
            const cards = column.querySelectorAll('.report-card .report-content');

            if (cards.length === 0) {
                alert('Î¶¨Ìè¨Ìä∏Ïóê ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }

            const blocks = Array.from(document.querySelectorAll(".report-card")).map(card => {
                const content = card.querySelector(".report-content");

                return {
                    html: content ? content.innerHTML : "",
                    plotData: card.dataset.plot ? JSON.parse(card.dataset.plot) : null,
                    chartId: card.dataset.chartId || null
                };
            });


            // Show loading state
            const originalButtonText = input.nextElementSibling.innerText;
            input.nextElementSibling.innerText = 'Ïã§Ìñâ Ï§ë...';
            input.nextElementSibling.disabled = true;

            try {
                const res = await fetch('/edit_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ blocks: blocks, instruction: instruction })
                });

                const data = await res.json();

                if (data.success) {
                    // [PHASE 6] Show Diff & Confirmation instead of immediate application
                    showDiffModal(data.blocks, column);
                    input.value = '';
                } else {
                    alert('Ïã§Ìñâ Ïã§Ìå®: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (err) {
                console.error('Report Agent error:', err);
                alert('Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            } finally {
                input.nextElementSibling.innerText = originalButtonText;
                input.nextElementSibling.disabled = false;
            }
        }

        // [PHASE 6] Diff Modal
        function showDiffModal(newBlocks, column) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.zIndex = '10001'; // Higher than others

            const modal = document.createElement('div');
            modal.className = 'modal-content';
            modal.style.width = '80%';
            modal.style.maxWidth = '900px';
            modal.style.height = '80vh';
            modal.style.display = 'flex';
            modal.style.flexDirection = 'column';

            // Header
            const header = document.createElement('div');
            header.innerHTML = '<h3>üìù Î≥ÄÍ≤Ω Ï†úÏïà ÌôïÏù∏</h3><p>AIÍ∞Ä Ï†úÏïàÌïú Î≥ÄÍ≤Ω ÎÇ¥Ïö©ÏùÑ ÌôïÏù∏ÌïòÍ≥† Ï†ÅÏö© Ïó¨Î∂ÄÎ•º Í≤∞Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.</p>';
            header.style.marginBottom = '20px';
            header.style.borderBottom = '1px solid #eee';
            header.style.paddingBottom = '10px';
            modal.appendChild(header);

            // Body (Split View)
            const body = document.createElement('div');
            body.style.display = 'flex';
            body.style.flex = '1';
            body.style.gap = '20px';
            body.style.overflow = 'hidden';

            // Left: Current
            const leftCol = document.createElement('div');
            leftCol.style.flex = '1';
            leftCol.style.overflowY = 'auto';
            leftCol.style.background = '#f9f9f9';
            leftCol.style.padding = '15px';
            leftCol.style.borderRadius = '8px';
            leftCol.innerHTML = '<h4 style="margin-top:0; color:#666;">ÌòÑÏû¨ Î¶¨Ìè¨Ìä∏</h4>';
            // Clone current content
            const currentContent = column.cloneNode(true);
            // Remove scripts/events? internalHTML is enough
            leftCol.innerHTML += currentContent.innerHTML;

            // Right: Proposed
            const rightCol = document.createElement('div');
            rightCol.style.flex = '1';
            rightCol.style.overflowY = 'auto';
            rightCol.style.background = '#e6f7ff'; // Light blue hint
            rightCol.style.padding = '15px';
            rightCol.style.borderRadius = '8px';
            rightCol.innerHTML = '<h4 style="margin-top:0; color:#007bff;">Î≥ÄÍ≤Ω Ï†úÏïà</h4>';

            const previewContainer = document.createElement('div');
            newBlocks.forEach(blockText => {
                const div = document.createElement('div');
                div.className = 'report-card';
                div.style.marginBottom = '10px';
                div.innerHTML = `<div class="report-content">${blockText}</div>`;
                previewContainer.appendChild(div);
            });
            rightCol.appendChild(previewContainer);

            body.appendChild(leftCol);
            body.appendChild(rightCol);
            modal.appendChild(body);

            // Footer (Actions)
            const footer = document.createElement('div');
            footer.style.marginTop = '20px';
            footer.style.display = 'flex';
            footer.style.justifyContent = 'flex-end';
            footer.style.gap = '10px';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'outline-btn';
            cancelBtn.innerText = 'Ï∑®ÏÜå (X)';
            cancelBtn.onclick = () => document.body.removeChild(overlay);

            const applyBtn = document.createElement('button');
            applyBtn.className = 'primary-btn';
            applyBtn.innerText = 'Ï†ÅÏö© (O)';
            applyBtn.onclick = () => {
                // Apply changes
                column.innerHTML = '';
                newBlocks.forEach(blockText => {
                    addToReport(blockText);
                });
                document.body.removeChild(overlay);
                // alert('Î¶¨Ìè¨Ìä∏Í∞Ä Ïû¨Íµ¨ÏÑ±ÎêòÏóàÏäµÎãàÎã§.');
            };

            footer.appendChild(cancelBtn);
            footer.appendChild(applyBtn);
            modal.appendChild(footer);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        // [PHASE 2] Show edit options popup
        function showEditOptions(contentDiv) {
            const modes = [
                { value: 'concise', label: 'Í∞ÑÍ≤∞ÌïòÍ≤å (Concise)' },
                { value: 'executive', label: 'ÏûÑÏõê Î≥¥Í≥†Ïö© (Executive)' },
                { value: 'marketing', label: 'ÎßàÏºÄÌåÖ ÏûêÎ£åÏö© (Marketing)' },
                { value: 'data-focused', label: 'Îç∞Ïù¥ÌÑ∞ Ï§ëÏã¨ (Data)' }
            ];

            const popup = document.createElement('div');
            popup.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.2); z-index:10000; min-width: 300px;';

            popup.innerHTML = '<h3 style="margin:0 0 16px 0;">AI Ìé∏Ïßë Î™®Îìú ÏÑ†ÌÉù</h3>';

            modes.forEach(mode => {
                const btn = document.createElement('button');
                btn.textContent = mode.label;
                btn.style.cssText = 'display:block; width:100%; padding:12px; margin:8px 0; background:#f9f9f9; color:#333; border:1px solid #eee; border-radius:6px; cursor:pointer; text-align:left; transition:all 0.2s;';
                btn.onmouseover = () => { btn.style.background = 'var(--primary-color)'; btn.style.color = 'white'; };
                btn.onmouseout = () => { btn.style.background = '#f9f9f9'; btn.style.color = '#333'; };
                btn.onclick = async () => {
                    document.body.removeChild(popup);
                    await editBlock(contentDiv, mode.value);
                };
                popup.appendChild(btn);
            });

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Ï∑®ÏÜå';
            cancelBtn.style.cssText = 'display:block; width:100%; padding:12px; margin:16px 0 0 0; background:#f5f5f5; color:#666; border:none; border-radius:6px; cursor:pointer;';
            cancelBtn.onclick = () => document.body.removeChild(popup);
            popup.appendChild(cancelBtn);

            document.body.appendChild(popup);
        }

        // [PHASE 2] Edit block using AI
        async function editBlock(contentDiv, mode) {
            const originalText = contentDiv.innerText;
            // Show loading state
            const originalContent = contentDiv.innerHTML;
            contentDiv.innerHTML = '<div style="color:var(--primary-color);"><i class="fas fa-spinner fa-spin"></i> AIÍ∞Ä Îã§Ïãú ÏûëÏÑ±ÌïòÍ≥† ÏûàÏäµÎãàÎã§...</div>';

            try {
                const res = await fetch('/edit_block', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: originalText, mode: mode })
                });

                const data = await res.json();

                if (data.success) {
                    contentDiv.innerHTML = data.edited;
                } else {
                    contentDiv.innerHTML = originalContent;
                    alert('Ìé∏Ïßë Ïã§Ìå®: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (err) {
                console.error('Edit block error:', err);
                contentDiv.innerHTML = originalContent;
                alert('Ìé∏Ïßë Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        function logout() { fetch('/logout').then(() => window.location.href = '/'); }
        function openReportPanel() { if (document.getElementById('report-panel').classList.contains('collapsed')) toggleReportPanel(); }
        function generateUniqueId() { return 'id-' + Math.random().toString(36).substr(2, 9); }
        function createNewReport() {
            document.getElementById('report').innerHTML = '<div class="report-column" data-column="1"></div>';
            openReportPanel();
        }
        async function saveReport() {
            const column = document.querySelector('.report-column');
            if (!column || column.children.length === 0) {
                alert('Ï†ÄÏû•Ìï† Î¶¨Ìè¨Ìä∏ ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }

            // Get title from input or use default
            const titleInput = document.getElementById('report-title');
            const title = titleInput.value.trim() || "AI Data Report " + new Date().toLocaleDateString();

            // Collect content (Simplified: HTML content or structured data)
            const reportContent = column.innerHTML;

            try {
                const res = await fetch('/save_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        content: reportContent
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Î¶¨Ìè¨Ìä∏Í∞Ä Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
                    loadReportsList(); // Refresh the reports list
                } else {
                    alert('Î¶¨Ìè¨Ìä∏ Ï†ÄÏû• Ïã§Ìå®: ' + (data.error || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'));
                }
            } catch (err) {
                alert('Î¶¨Ìè¨Ìä∏ Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                console.error(err);
            }
        }

        async function loadReportsList() {
            try {
                const res = await fetch('/list_reports');
                const data = await res.json();
                const reportsList = document.getElementById('reports-list');

                if (data.success && data.reports && data.reports.length > 0) {
                    reportsList.innerHTML = '';
                    data.reports.forEach(report => {
                        const li = document.createElement('li');
                        li.className = 'menu-item';
                        li.style.cursor = 'pointer';
                        li.innerHTML = `<i class="fas fa-file-alt"></i> ${report.title}`;
                        li.onclick = () => loadReport(report.id);
                        reportsList.appendChild(li);
                    });
                } else {
                    reportsList.innerHTML = '<li style="padding:10px; color:var(--text-muted); font-style:italic;">No saved reports</li>';
                }
            } catch (err) {
                console.error('Failed to load reports:', err);
            }
        }

        async function loadReport(reportId) {
            try {
                const res = await fetch(`/get_report/${reportId}`);
                const data = await res.json();

                if (data.success && data.report) {
                    const column = document.querySelector('.report-column');
                    if (column) {
                        column.innerHTML = data.report.content;
                    }

                    const titleInput = document.getElementById('report-title');
                    if (titleInput) {
                        titleInput.value = data.report.title;
                    }

                    openReportPanel();

                    // üî• Ï∞®Ìä∏ Î≥µÏõê Ïã§Ìñâ
                    restoreReportCharts();
                } else {
                    alert('Î¶¨Ìè¨Ìä∏Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
            } catch (err) {
                console.error('Failed to load report:', err);
                alert('Î¶¨Ìè¨Ìä∏ Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        function restoreReportCharts() {
            const cards = document.querySelectorAll(".report-card");

            cards.forEach(card => {
                const plotStr = card.dataset.plot;
                const chartId = card.dataset.chartId;

                if (!plotStr || !chartId) return;

                let plotData;
                try {
                    plotData = JSON.parse(plotStr);
                } catch (e) {
                    console.warn("Invalid plotData JSON:", e);
                    return;
                }

                const chartDiv = document.getElementById(chartId);

                // chart divÍ∞Ä ÏóÜÎã§Î©¥ ÏÉàÎ°ú ÎßåÎì§Ïñ¥Ï§å
                if (!chartDiv) {
                    const wrapper = document.createElement("div");
                    wrapper.style.marginTop = "10px";

                    const newChartDiv = document.createElement("div");
                    newChartDiv.id = chartId;
                    newChartDiv.style.minHeight = "200px";

                    wrapper.appendChild(newChartDiv);
                    card.appendChild(wrapper);
                }

                // Î†åÎçî
                setTimeout(() => {
                    renderApexChart(chartId, {
                        ...plotData,
                        height: 250
                    });
                }, 50);
            });
        }

        function filterReports() {
            const searchInput = document.getElementById('search-reports');
            const filter = searchInput.value.toLowerCase();
            const reportsList = document.getElementById('reports-list');
            const items = reportsList.getElementsByClassName('menu-item');

            for (let i = 0; i < items.length; i++) {
                const text = items[i].textContent || items[i].innerText;
                if (text.toLowerCase().indexOf(filter) > -1) {
                    items[i].style.display = '';
                } else {
                    items[i].style.display = 'none';
                }
            }
        }
        function downloadReportAsImage() { alert('Îã§Ïö¥Î°úÎìú Í∏∞Îä• Ï§ÄÎπÑ Ï§ë'); }
        function uploadFile() { alert('ÌååÏùº ÏóÖÎ°úÎìú Í∏∞Îä• Ï§ÄÎπÑ Ï§ë'); }
        function loadColumns() { }

        // [PHASE 4] Initialize Sortable
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for element to exist? It exists in HTML.
            initSortable();
        });

        function initSortable() {
            const reportColumn = document.querySelector('.report-column');
            if (reportColumn && typeof Sortable !== 'undefined') {
                new Sortable(reportColumn, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    handle: '.report-card', // Draggable by whole card
                    onEnd: function (evt) {
                        console.log('Block reordered');
                    }
                });
            }
        }

        // [PHASE 7] Toggle View Mode
        function toggleViewMode(checkbox) {
            const container = document.getElementById('report-container');
            const contents = document.querySelectorAll('.report-content');

            if (checkbox.checked) {
                container.classList.add('view-mode');
                // Disable contentEditable
                contents.forEach(c => c.contentEditable = 'false');
            } else {
                container.classList.remove('view-mode');
                // Enable contentEditable
                contents.forEach(c => c.contentEditable = 'true');
            }
        }
    </script>
</body>

</html>